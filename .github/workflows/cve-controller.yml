# =============================================================================
# CVE Remediation Controller - CodeFlare SDK
# =============================================================================
# This workflow scans the codeflare-sdk repository for a specific CVE and
# creates a Renovate PR to fix the vulnerable dependency.
#
# Usage:
# 1. Create a GitHub issue to track the CVE
# 2. Trigger this workflow with:
#    - cve_id: The CVE to check for (e.g., CVE-2024-12345)
#    - issue_number: The tracking issue number
#    - release_tag: The release to check (e.g., v0.32.0)
# 3. The workflow will:
#    - Create a fix branch: cve-fix/<cve-id>-<release-tag>
#    - Scan the release for the CVE
#    - If not affected: comment and close the issue
#    - If affected: create a Renovate PR to fix the dependency
#
# PAT Requirements:
# The CVE_CONTROLLER_PAT secret needs repo scope for PR creation
# =============================================================================

name: CVE Remediation Controller

on:
  workflow_dispatch:
    inputs:
      cve_id:
        description: 'CVE identifier (e.g., CVE-2024-12345)'
        required: true
        type: string
      issue_number:
        description: 'GitHub Issue ID to update with status'
        required: true
        type: string
      release_tag:
        description: 'Release tag to base the fix branch from (e.g., v0.32.0)'
        required: true
        type: string
      # -------------------------------------------------------------------------
      # Override inputs for testing with forks
      # -------------------------------------------------------------------------
      repo_override:
        description: 'Override repo for testing (e.g., your-username/codeflare-sdk)'
        required: false
        type: string

# Ensure only one CVE remediation runs at a time
concurrency:
  group: cve-sdk-${{ github.event.inputs.cve_id }}-${{ github.event.inputs.release_tag }}
  cancel-in-progress: false

env:
  # Default repository - can be overridden for testing
  TARGET_REPO: ${{ inputs.repo_override || 'project-codeflare/codeflare-sdk' }}

jobs:
  # ===========================================================================
  # Job 1: Scan for CVE
  # ===========================================================================
  scan:
    name: Scan for CVE
    runs-on: ubuntu-latest
    outputs:
      vulnerable: ${{ steps.scan.outputs.vulnerable }}
      package_name: ${{ steps.scan.outputs.package_name }}
      fix_branch: ${{ steps.branch.outputs.fix_branch }}

    steps:
      # -----------------------------------------------------------------------
      # Step 1: Generate branch name from CVE and release tag
      # Format: cve-fix/<cve-id>-<release-tag>
      # -----------------------------------------------------------------------
      - name: Generate fix branch name
        id: branch
        run: |
          # Create branch name: cve-fix/CVE-2024-12345-v0.32.0
          CVE_ID="${{ inputs.cve_id }}"
          RELEASE_TAG="${{ inputs.release_tag }}"

          # Sanitize for branch name (lowercase, replace invalid chars)
          FIX_BRANCH="cve-fix/${CVE_ID}-${RELEASE_TAG}"
          FIX_BRANCH=$(echo "$FIX_BRANCH" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9./-]/-/g')

          echo "fix_branch=${FIX_BRANCH}" >> $GITHUB_OUTPUT
          echo "Generated fix branch: ${FIX_BRANCH}"

      # -----------------------------------------------------------------------
      # Step 2: Create branch from release tag
      # -----------------------------------------------------------------------
      - name: Create fix branch from release tag
        run: |
          FIX_BRANCH="${{ steps.branch.outputs.fix_branch }}"
          RELEASE_TAG="${{ inputs.release_tag }}"

          echo "Creating branch ${FIX_BRANCH} from tag ${RELEASE_TAG}"

          git clone https://x-access-token:${{ secrets.CVE_CONTROLLER_PAT }}@github.com/${{ env.TARGET_REPO }}.git repo
          cd repo

          git config user.email "cve-controller@github.com"
          git config user.name "CVE Controller"

          # Check if branch already exists
          if git ls-remote --heads origin "${FIX_BRANCH}" | grep -q .; then
            echo "Branch ${FIX_BRANCH} already exists, will use existing branch"
          else
            echo "Creating new branch from tag ${RELEASE_TAG}"
            git fetch --tags
            git checkout tags/${RELEASE_TAG} -b "${FIX_BRANCH}"
            git push origin "${FIX_BRANCH}"
          fi

      # -----------------------------------------------------------------------
      # Step 3: Checkout the fix branch
      # -----------------------------------------------------------------------
      - name: Checkout fix branch
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TARGET_REPO }}
          ref: ${{ steps.branch.outputs.fix_branch }}
          token: ${{ secrets.CVE_CONTROLLER_PAT }}
          fetch-depth: 0

      # -----------------------------------------------------------------------
      # Step 3: Setup Python and scan
      # -----------------------------------------------------------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Scan for CVE
        id: scan
        run: |
          set +e

          CVE_ID="${{ inputs.cve_id }}"
          VULNERABLE="false"
          PACKAGE_NAME=""

          echo "=== Scanning for ${CVE_ID} ==="

          # Install dependencies
          echo "Installing dependencies..."
          pip install -e . 2>/dev/null || pip install -r requirements.txt 2>/dev/null || true

          # Run pip-audit
          echo "Running pip-audit..."
          AUDIT_RESULT=$(pip-audit --format json 2>/dev/null || echo "[]")

          # Save for debugging
          echo "$AUDIT_RESULT" > /tmp/pip-audit-output.json
          echo "Full output saved to /tmp/pip-audit-output.json"

          # Search for the CVE
          MATCH=$(echo "$AUDIT_RESULT" | jq -r ".[] | select(.vulns[]?.id == \"${CVE_ID}\" or .vulns[]?.aliases[]? == \"${CVE_ID}\")" 2>/dev/null || echo "")

          if [ -n "$MATCH" ] && [ "$MATCH" != "null" ]; then
            VULNERABLE="true"
            PACKAGE_NAME=$(echo "$MATCH" | jq -r '.name' | head -1)
            echo "Found vulnerability! Package: $PACKAGE_NAME"
          fi

          echo "vulnerable=${VULNERABLE}" >> $GITHUB_OUTPUT
          echo "package_name=${PACKAGE_NAME}" >> $GITHUB_OUTPUT
          echo "timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

          echo "=== Scan Complete. Vulnerable: ${VULNERABLE} ==="

      # -----------------------------------------------------------------------
      # Step 4: Report results
      # -----------------------------------------------------------------------
      - name: Comment - Not Vulnerable
        if: steps.scan.outputs.vulnerable == 'false'
        run: |
          gh issue comment ${{ inputs.issue_number }} \
            --repo ${{ env.TARGET_REPO }} \
            --body "## ‚úÖ CVE Scan Result: Not Vulnerable

          | Field | Value |
          |-------|-------|
          | CVE | ${{ inputs.cve_id }} |
          | Release Tag | ${{ inputs.release_tag }} |
          | Fix Branch | ${{ steps.branch.outputs.fix_branch }} |
          | Scan Time | ${{ steps.scan.outputs.timestamp }} |

          The CVE was **not detected** in the dependencies for this release.

          Closing this issue."

          gh issue close ${{ inputs.issue_number }} --repo ${{ env.TARGET_REPO }} --reason "not planned"
        env:
          GH_TOKEN: ${{ secrets.CVE_CONTROLLER_PAT }}

      - name: Comment - Vulnerable
        if: steps.scan.outputs.vulnerable == 'true'
        run: |
          gh issue comment ${{ inputs.issue_number }} \
            --repo ${{ env.TARGET_REPO }} \
            --body "## ‚ö†Ô∏è CVE Scan Result: Vulnerable

          | Field | Value |
          |-------|-------|
          | CVE | ${{ inputs.cve_id }} |
          | Release Tag | ${{ inputs.release_tag }} |
          | Fix Branch | ${{ steps.branch.outputs.fix_branch }} |
          | Affected Package | \`${{ steps.scan.outputs.package_name }}\` |

          Triggering Renovate to create a fix PR..."
        env:
          GH_TOKEN: ${{ secrets.CVE_CONTROLLER_PAT }}

  # ===========================================================================
  # Job 2: Create Fix PR
  # ===========================================================================
  fix:
    name: Create Fix PR
    needs: scan
    if: needs.scan.outputs.vulnerable == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (for Renovate config)
        uses: actions/checkout@v4

      - name: Run Renovate
        uses: renovatebot/github-action@v46.0.1
        with:
          configurationFile: .github/renovate-cve-config.js
          token: ${{ secrets.CVE_CONTROLLER_PAT }}
        env:
          RENOVATE_TARGET_REPO: ${{ env.TARGET_REPO }}
          RENOVATE_BASE_BRANCH: ${{ needs.scan.outputs.fix_branch }}
          RENOVATE_PACKAGE_NAME: ${{ needs.scan.outputs.package_name }}
          RENOVATE_CVE_ID: ${{ inputs.cve_id }}
          RENOVATE_ISSUE_NUMBER: ${{ inputs.issue_number }}
          RENOVATE_ISSUE_REPO: ${{ env.TARGET_REPO }}
          RENOVATE_COMPONENT: codeflare-sdk
          RENOVATE_STREAM: main
          RENOVATE_SCAN_TYPE: python
          LOG_LEVEL: debug

      - name: Comment - PR Created
        run: |
          gh issue comment ${{ inputs.issue_number }} \
            --repo ${{ env.TARGET_REPO }} \
            --body "## üîß Fix PR Initiated

          | Field | Value |
          |-------|-------|
          | Package | \`${{ needs.scan.outputs.package_name }}\` |
          | Fix Branch | ${{ needs.scan.outputs.fix_branch }} |
          | CVE | ${{ inputs.cve_id }} |

          Renovate has been triggered. Check the repository for the new PR."
        env:
          GH_TOKEN: ${{ secrets.CVE_CONTROLLER_PAT }}

      - name: Comment on failure
        if: failure()
        run: |
          gh issue comment ${{ inputs.issue_number }} \
            --repo ${{ env.TARGET_REPO }} \
            --body "## ‚ùå Fix PR Failed

          Renovate failed to create a PR. Check the workflow logs:
          ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        env:
          GH_TOKEN: ${{ secrets.CVE_CONTROLLER_PAT }}
