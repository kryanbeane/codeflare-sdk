// =============================================================================
// Renovate CVE Remediation Configuration - CodeFlare SDK
// =============================================================================
// This config is used by the CVE Remediation Controller to create fix PRs.
//
// Environment variables from workflow:
// - RENOVATE_TARGET_REPO: Repository to create PR in
// - RENOVATE_BASE_BRANCH: Branch to target
// - RENOVATE_PACKAGE_NAME: Vulnerable package to update
// - RENOVATE_CVE_ID: CVE identifier
// - RENOVATE_ISSUE_NUMBER: Tracking issue number
// - RENOVATE_ISSUE_REPO: Repository with the tracking issue
// =============================================================================

const prBody = `## Security Update

This PR fixes **${process.env.RENOVATE_CVE_ID || 'CVE'}** by updating \`${process.env.RENOVATE_PACKAGE_NAME || 'package'}\`.

**Tracking Issue:** ${process.env.RENOVATE_ISSUE_REPO || ''}#${process.env.RENOVATE_ISSUE_NUMBER || ''}

---
*Created by [CVE Remediation Controller](https://github.com/project-codeflare/codeflare-sdk/blob/main/.github/workflows/cve-controller.yml)*
`;

module.exports = {
  platform: 'github',
  onboarding: false,
  requireConfig: 'ignored',

  // Target repo and branch
  repositories: [process.env.RENOVATE_TARGET_REPO].filter(Boolean),
  baseBranches: [process.env.RENOVATE_BASE_BRANCH].filter(Boolean),

  // Python package managers
  enabledManagers: ['pip_requirements', 'poetry', 'pep621'],

  // Only update the vulnerable package
  packageRules: [
    {
      matchPackagePatterns: [process.env.RENOVATE_PACKAGE_NAME].filter(Boolean),
      enabled: true,
      recreateWhen: 'always',
      rebaseWhen: 'behind-base-branch',
      prPriority: 99,
      labels: ['security', 'cve-fix', process.env.RENOVATE_CVE_ID].filter(Boolean),
    },
    {
      // Disable everything else
      matchPackagePatterns: ['*'],
      excludePackagePatterns: [process.env.RENOVATE_PACKAGE_NAME].filter(Boolean),
      enabled: false,
    },
  ],

  // PR configuration
  prTitle: `fix(security): Update ${process.env.RENOVATE_PACKAGE_NAME || 'package'} [${process.env.RENOVATE_CVE_ID || 'CVE'}]`,
  prBody: prBody,
  branchPrefix: 'cve-fix/',
  branchName: `cve-fix/${process.env.RENOVATE_CVE_ID || 'cve'}-${process.env.RENOVATE_PACKAGE_NAME || 'pkg'}`.toLowerCase().replace(/[^a-z0-9-/]/g, '-'),

  // No dashboard needed
  dependencyDashboard: false,

  // No rate limits for security fixes
  prHourlyLimit: 0,
  prConcurrentLimit: 0,
  branchConcurrentLimit: 0,

  // Commit message
  commitMessagePrefix: 'fix(security):',

  logLevel: process.env.LOG_LEVEL || 'info',
};
